# CineFlow 重构计划方案

**版本**: v1.0  
**日期**: 2026-01-02  
**状态**: 待审批  

---

## 1. 目标设定

### 1.1 业务目标
*   **平台化转型**：将 CineFlow 从单机 CLI 工具升级为支持多人协作的 Web 视频生成平台。
*   **用户体验升级**：提供可视化界面（Dashboard），降低用户使用门槛，实现任务进度的实时监控与可视化管理。
*   **规模化生产**：支持任务队列管理和并发控制，提升批量视频生成的效率和稳定性。

### 1.2 技术目标
*   **架构解耦**：实现彻底的前后端分离，后端专注于业务逻辑与 API 提供，前端专注于交互体验。
*   **标准化接口**：建立符合 OpenAPI 标准的 RESTful API，确保接口的可维护性和扩展性。
*   **代码质量提升**：消除 `worker.py` 与 `interactor.py` 中的逻辑耦合，建立清晰的分层架构（Controller/Service/Repository）。
*   **多供应商抽象**：将 `sora.hk` 的硬编码调用解耦为可扩展 Provider 层，支持 OpenAI 官方与第三方 Sora 服务差异化接入与调度。

### 1.3 成功指标 (KPIs)
*   **测试覆盖率**：核心业务逻辑（Service 层）单元测试覆盖率达到 **80%** 以上。
*   **开发效率**：新功能上线周期缩短 **30%**（基于前后端并行开发模式）。
*   **性能指标**：API 平均响应时间 < 200ms（非生成类接口）；支持并发任务数提升至 **50+**。
*   **代码规范**：Pylint/Flake8 评分 > 9.0；无严重安全漏洞（Bandit 扫描）。

### 1.4 里程碑规划
| 阶段 | 里程碑名称 | 预计周期 | 核心交付物 |
| :--- | :--- | :--- | :--- |
| **P0** | **后端核心重构** | 2 周 | FastAPI 框架搭建、Service 层解耦、Provider 抽象、Swagger 文档生成 |
| **P1** | **前端基础建设** | 2 周 | Next.js App Router、Tailwind + shadcn/ui、API Client 自动生成 |
| **P2** | **核心功能联调** | 2 周 | 任务提交/查询全流程跑通、JWT 认证集成 |
| **P3** | **部署与验收** | 1 周 | Vercel 前端部署、后端容器化、CI/CD 流水线、性能压测报告 |

---

## 2. 步骤分解

### Phase 1: 后端架构重构 (Backend Refactoring)
*优先级：High | 依赖：无*

*   **Task 1.1: 目录结构调整**
    *   创建 `backend/app` 目录结构（api, core, services, schemas）。
    *   迁移 `src/models.py` 到 `backend/app/schemas`。
    *   迁移 `src/config.py` 到 `backend/app/core`。
*   **Task 1.2: 业务逻辑剥离**
    *   拆解 `src/worker.py`，将纯业务逻辑（Sora API 调用、Prompt 处理）提取为 `Service` 类。
    *   移除 `Service` 层中所有 `rich` 相关的 CLI 输出代码。
*   **Task 1.3: Provider 抽象与多厂商接入**
    *   定义 Provider 接口层（create_task / get_task / capabilities / limits）。
    *   实现 `SoraHKProvider`、`OpenAIProvider`、`ThirdPartyProvider` 等适配器。
    *   建立能力与限制映射（分辨率、时长、并发、费用、请求限额等）。
    *   建立 Provider 注册表与路由选择器。
    *   输出设计文档: `docs/provider_strategy.md`
    *   建立逻辑模型注册表（Sora2 / Sora2Pro）与 Provider 模型映射关系
    *   增加管理后台接口（仅内部使用）用于维护 Provider 状态、优先级与逻辑模型映射
*   **Task 1.4: 调度策略**
    *   前端可选 Provider（显式选择）与后端默认 Provider（系统配置）。
    *   支持主备切换与负载均衡策略（基于配额、错误率、延迟、成本）。
    *   引入策略配置与审计日志，便于回溯与调优。
*   **Task 1.5: API 接口定义**
    *   基于 Pydantic Model 定义 API Request/Response Schema。
    *   编写 FastAPI Controller（Router），生成 OpenAPI (Swagger) 文档。

### Phase 2: 前端项目初始化 (Frontend Initialization)
*优先级：High | 依赖：Task 1.5*

*   **Task 2.1: 脚手架搭建**
    *   使用 Next.js App Router 初始化 TypeScript 项目（Vercel 友好）。
    *   配置 ESLint, Prettier 及 Git Hooks。
*   **Task 2.2: 基础服务层**
    *   引入 `openapi-typescript-codegen` 或类似工具，基于后端 Swagger 自动生成 API Client。
    *   配置 Axios/Fetch 拦截器（处理 JWT Token 注入及全局错误）。
*   **Task 2.3: 核心页面开发**
    *   开发 Dashboard 布局（Sidebar, Header）。
    *   开发“新建任务”表单页面（对应分镜 JSON 输入）。

### Phase 3: 认证与安全 (Auth & Security)
*优先级：Medium | 依赖：Task 1.1*

*   **Task 3.1: JWT 认证实现**
    *   后端实现 `/auth/login` 接口，签发 Access Token。
    *   后端实现 `get_current_user` 依赖注入，保护私有路由。
*   **Task 3.2: 安全加固**
    *   配置 CORS 策略。
    *   确保 API Key 等敏感配置仅在后端内存中流转。

---

## 3. 技术栈实施

### 3.1 核心技术选型
| 领域 | 技术/工具 | 选型理由 |
| :--- | :--- | :--- |
| **后端框架** | **FastAPI** (Python) | 高性能（基于 Starlette），原生支持异步（AsyncIO），自动生成 OpenAPI 文档，Pydantic 深度集成。 |
| **前端框架** | **Next.js (App Router) + TypeScript** | SSR/CSR 混合渲染，路由与数据流标准化，Vercel 原生支持。 |
| **构建工具** | **Next.js (内置构建 + Turbopack)** | 开发/构建一体化，零配置部署，性能稳定。 |
| **UI 组件库** | **TailwindCSS + shadcn/ui** | 轻量、可定制，适合构建现代化管理后台。 |
| **依赖管理** | **Poetry** (后端) / **pnpm** (前端) | 锁定依赖版本，确保环境一致性。 |
| **部署平台** | **Vercel (前端)** | 快速部署，预览环境友好，支持自动化 CI/CD。 |

### 3.2 代码规范
*   **Python**: 遵循 PEP 8，使用 `Black` 格式化，`Isort` 排序导入，`MyPy` 进行静态类型检查。
*   **TypeScript**: 使用 `ESLint` (Airbnb 或 Standard 规则)，`Prettier` 格式化。
*   **Commit Message**: 遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范（feat, fix, docs, refactor 等）。

### 3.3 测试策略
*   **单元测试 (Unit Test)**:
    *   后端：使用 `pytest`。重点测试 Service 层的业务逻辑（如 Prompt 拼接、状态流转）。Mock 外部 API 调用。
    *   覆盖率要求：> 80%。
*   **集成测试 (Integration Test)**:
    *   后端：使用 `TestClient` (FastAPI) 测试 API 端点。
    *   前端：使用 `Vitest` + `React Testing Library` 测试关键组件交互。
*   **E2E 测试**: 可选 Cypress 或 Playwright，覆盖核心用户旅程（登录 -> 创建任务 -> 查看结果）。

---

## 4. 风险预案

### 4.1 风险识别与应对
| 风险点 | 风险描述 | 应对方案 (Plan A) | 备选方案 (Plan B) |
| :--- | :--- | :--- | :--- |
| **CLI 耦合过深** | 现有代码中业务逻辑与 CLI 交互（Rich）紧密缠绕，剥离困难。 | **逐步提取法**：先复制一份代码到 `services/`，通过单元测试驱动逐步删除 UI 代码。 | **适配器模式**：保留原有函数，编写 Wrapper 类拦截标准输出，但不推荐（技术债务）。 |
| **API 变更** | Sora API 可能发生不兼容更新。 | **防腐层 (ACL)**：在 `clients/` 层封装所有外部调用，业务层仅依赖内部接口。 | **Mock 回滚**：快速切换到 Mock 模式，暂停线上服务进行热修复。 |
| **前后端进度不一** | 前端开发依赖后端接口完成，可能造成阻塞。 | **契约先行**：后端先出 Swagger 文档（即口头/文档契约），前端使用 MSW (Mock Service Worker) 开发。 | **硬编码开发**：前端先使用硬编码数据开发 UI，后期替换。 |

### 4.2 回滚机制
*   **代码回滚**：Git 分支管理，Main 分支始终保持可部署状态。重构在 `refactor/v2-architecture` 分支进行。
*   **服务降级**：如果 Web 端出现严重 Bug，保留 CLI 工具作为备用操作入口（Legacy Mode）。

---

## 5. 文档要求

### 5.1 文档格式
*   所有文档统一存储在 `docs/` 目录下。
*   使用 Markdown (`.md`) 格式。
*   图片资源存储在 `docs/assets/`。

### 5.2 变更记录 (Changelog)
在每个文档头部维护变更记录：
```markdown
| 版本 | 日期 | 修改人 | 修改内容 |
| :--- | :--- | :--- | :--- |
| v1.0 | 2026-01-02 | Trae | 初始创建 |
```

### 5.3 Review 与验收
*   **设计评审**：在开始编码前，必须提交 API 定义文档（Swagger YAML/JSON 或 Markdown 表格）进行评审。
*   **代码审查 (Code Review)**：所有 PR 必须经过至少 1 人 Review，CI 流水线（Lint + Test）通过后方可合并。
*   **同步机制**：代码变更如涉及 API 修改，必须同步更新 Swagger 文档及前端类型定义。

---

## 6. 阶段性交付评估（当前版本）

### 6.1 阶段结论
当前可作为**最小闭环 Beta 版本**交付（核心流程可用、前后端已打通、真实 Provider 下载验证通过），但距离商业化可用仍有明显差距，需进入下一阶段继续补齐。

### 6.2 下一阶段必做清单（从 Beta → 商业化）
*   **i18n 完整化**：清理硬编码文案，严格中英分离；补齐全量 key 与缺失翻译；增加语言切换验收用例。
*   **管理后台增强**：支持 Provider priority/weight/enable、Model provider_map 编辑、routing_strategy 设置；增加权限与审计。
*   **异常上报闭环**：前端接入 `/client-events`；后端落库、聚合统计与告警配置。
*   **认证与权限体系**：前端提供登录/Token 管理入口；后端分级权限（只读/管理员）。
*   **数据持久化**：替换内存存储为数据库；提供迁移脚本与备份/清理策略。
*   **可观测性指标**：任务耗时、失败原因、供应商分布、下载成功率等指标看板。
*   **用户体验打磨**：状态/错误提示统一、失败引导、加载与空态优化、下载失败指引。
*   **部署与环境治理**：前后端分离部署、CI/CD、配置管理（多环境）与回滚策略。
*   **安全与合规**：日志脱敏、速率限制、访问审计、敏感信息保护。

### 6.3 商业化差距说明
*   **完整性**：核心功能虽可用，但缺少管理与权限、持久化、监控与可观测性支撑。
*   **体验**：文案一致性、错误引导、系统反馈与多语言细节未达专业产品标准。
*   **运维**：缺少稳定的部署与回滚策略，无法满足生产环境 SLA。
