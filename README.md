# CineFlow (影流) - 通用视频生成流水线

[![Python](https://img.shields.io/badge/Python-3.9%2B-blue)](https://www.python.org/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)

CineFlow 是一个企业级的通用视频生成流水线后端程序，支持多服务商、多模型聚合。专为高并发、大规模分镜任务设计，提供从脚本解析到自适应并发控制的完整流程。

## ⚠️ 服务与差异说明 (Important Disclaimer)

**本项目目前主要基于 [Sora.hk](https://www.sora.hk/) API 进行开发，并非 OpenAI 官方直接服务。**

虽然该服务采用了兼容 OpenAI (NewAPI) 的接口格式，但在以下方面存在本质差异：
1.  **底层模型**: 服务商可能对模型进行了封装或优化，与 OpenAI 官方 Sora 模型的原始表现可能存在差异。
2.  **参数逻辑**: 引入了 `is_pro` (Pro模式)、`remove_watermark` 等特定参数，这些是 OpenAI 官方文档中可能不存在或定义不同的。
3.  **计费方式**: 遵循服务商的定价策略（按次或按时长计费），而非 OpenAI Token 计费。
4.  **网络连接**: 该服务支持国内直连，无需复杂的网络环境配置。

## ✨ 核心特性

*   **⚡️ 高效并发**: 基于 `ThreadPoolExecutor` 的多线程架构，默认支持 20 线程并发。
*   **🛡️ 自适应熔断 (Circuit Breaker)**: 
    *   **智能降级**: 当检测到连续 API 错误（如 429/5xx）时，自动将并发数从 20 降级为 5（安全模式）。
    *   **缓慢恢复**: 触发熔断后冷却 10 分钟，随后每分钟自动释放 1 个并发名额，直至恢复满载。
*   **💾 断点续传**: 生成前自动检查输出目录，已存在且完整的文件会自动跳过 (Skipped)，避免重复扣费。
*   **🎥 长时任务支持**: 针对多模型优化的轮询策略，支持最长 35 分钟的生成等待，内置 Request ID 追踪。
*   **🔄 健壮性设计**: 
    *   **防惊群 (Jitter)**: 任务启动随机抖动，防止瞬间流量冲击。
    *   **原子写入**: 文件先下载为 `.tmp`，校验完整后重命名，杜绝损坏文件。
    *   **内存保护**: 流式下载 (1MB Chunk) + 主动 GC 回收。
*   **🖥️ 全中文交互**: 漂亮的 CLI 界面，支持交互式分镜向导与 Ctrl+C 优雅退出。

## 🗺️ 后续计划 (Roadmap)

我们计划在未来版本中逐步引入以下高级特性，以增强工程化能力：

1.  **🖼️ 本地图片自动上云**: 
    *   集成开源图床工具，解决本地图片无法直接作为 `image_url` 输入的问题，实现“本地选图 -> 自动上传 -> 提交任务”的闭环。
2.  **🧩 多参考图矩阵拼接**: 
    *   解决单图限制。通过预处理逻辑，自动将“角色图 + 场景图 + 道具图”智能拼接为一张矩阵图作为输入，提升可控性。
3.  **🎭 角色一致性**: 深度适配多镜头 Character 能力，通过在 Prompt 中嵌入固定的 **角色ID (Role ID)** 格式，实现多镜头下的角色形象统一。
4.  **🔌 多服务商与多模型聚合**: 
    *   **新接入计划**: 增加对 **[贞贞的AI工坊](https://ai.t8star.cn)** 和 **[推理时代](https://aihubmix.com)** 的支持。
    *   **多模型扩展**: 计划适配 Nano Banana Pro、Grok Imagine、Veo 3.1、Wan 2.6 等前沿视频生成模型。
5.  **📝 LLM 剧本预处理模块**: 
    *   计划引入 LLM 辅助模块，实现从“自然语言剧本/小说”到“标准化分镜 JSON”的自动化转换与拆解。
6.  **🖥️ 跨平台 GUI 客户端 (待定)**: 
    *   计划基于 Electron 或 Web 技术开发简易前端，提供 Windows/macOS/Linux 通用的图形化操作界面。

## 🛠️ 快速开始

### 1. 环境准备

确保已安装 Python 3.9 或更高版本。

```bash
# 1. 克隆项目
git clone https://github.com/XucroYuri/CineFlow.git
cd CineFlow

# 2. 安装依赖
pip install -r requirements.txt
```